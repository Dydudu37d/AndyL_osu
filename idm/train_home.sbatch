#!/bin/bash
#SBATCH --job-name=osu_ddp_home
#SBATCH --partition=4V100PX           # ä¾ç„¶å»ºè®®ç”¨ PX åˆ†åŒºï¼Œæ’é˜Ÿå¯èƒ½å¿«äº›ï¼Œæˆ–è€…æ”¹å› 4V100 [cite: 161, 163]
#SBATCH --nodes=1
#SBATCH --ntasks=4                    # DDP å¿…é¡»è®¾ä¸º 4 [cite: 197]
#SBATCH --gpus-per-node=4
#SBATCH --qos=rush-4gpu               # 4å¡é«˜ä¼˜å…ˆçº§ [cite: 46]
#SBATCH --output=logs/%j_home.out
#SBATCH --error=logs/%j_home.err

# --- 1. ç¯å¢ƒå‡†å¤‡ ---
source /opt/devtools/anaconda3/bin/activate train_osu_idm

# --- 2. è·¯å¾„é…ç½® (ç›´æ¥æŒ‡å‘ Home) ---
# ã€è¯·ä¿®æ”¹æ­¤å¤„ã€‘ä¸ºæ‚¨å­˜æ”¾æ•°æ®çš„çœŸå®ç›®å½•
# æ³¨æ„ï¼šæ•°æ®å¿…é¡»å·²ç»åœ¨ /home ä¸‹ï¼Œä¸èƒ½åœ¨ç™»å½•èŠ‚ç‚¹çš„ /cache_local é‡Œ
DATA_PATH="/home/testgroup01/wangzirui/"

# æ¨¡å‹ä¿å­˜è·¯å¾„
CKPT_PATH="/home/testgroup01/wangzirui/checkpoints_v100"

# --- 3. å®‰å…¨æ£€æŸ¥ ---
if [ ! -f "$DATA_PATH/dataset_meta.npz" ]; then
    echo "âŒ é”™è¯¯ï¼šåœ¨è·¯å¾„ $DATA_PATH ä¸‹æ²¡æ‰¾åˆ°æ•°æ®é›†ï¼"
    echo "âš ï¸ æé†’ï¼šè®¡ç®—èŠ‚ç‚¹æ— æ³•è®¿é—®ç™»å½•èŠ‚ç‚¹çš„ /cache_localï¼Œè¯·ç¡®ä¿æ•°æ®çœŸçš„åœ¨ /home ç›®å½•ä¸‹ã€‚"
    exit 1
fi

# --- 4. è®¾ç½®ç¯å¢ƒå˜é‡ ---
# ç›´æ¥å‘Šè¯‰ Python è„šæœ¬å» Home ç›®å½•è¯»æ•°æ®
export LOCAL_DATA_DIR="$DATA_PATH"
export CHECKPOINT_DIR="$CKPT_PATH"

# ç¡®ä¿æƒé‡ç›®å½•å­˜åœ¨
mkdir -p "$CKPT_PATH"

# --- 5. å¯åŠ¨è®­ç»ƒ ---
echo "âœ… æ¨¡å¼ï¼šç›´è¿ Global Home å­˜å‚¨ï¼Œè·³è¿‡æœ¬åœ°ç¼“å­˜æ¬è¿"
echo "ğŸ“‚ æ•°æ®è·¯å¾„: $DATA_PATH"

# å¯åŠ¨ç›‘æ§
nvidia-smi dmon -s pucvmte -o T > logs/${SLURM_JOB_ID}_gpu_monitor.log &

# å¯åŠ¨ DDP è®­ç»ƒ
torchrun --nproc_per_node=4 train.py

exit
